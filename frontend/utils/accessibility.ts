/**
 * Ï†ëÍ∑ºÏÑ± Í¥ÄÎ†® Ïú†Ìã∏Î¶¨Ìã∞
 */

// ÏÉâÎßπ ÏπúÌôîÏ†Å ÏÉâÏÉÅ ÌåîÎ†àÌä∏
export const AccessibleColors = {
  // ÏÉâÎßπ ÏπúÌôîÏ†Å ÌåîÎ†àÌä∏ (Colorbrewer 2.0 Í∏∞Î∞ò)
  positive: {
    primary: '#1E88E5',    // ÌååÎûë (Î™®Îì† ÏÉâÎßπ Ïú†ÌòïÏóê ÏïàÏ†Ñ)
    secondary: '#43A047',  // Ï¥àÎ°ù (Ï†ÅÎ°ùÏÉâÎßπ Í≥†Î†§)
    text: '#0D47A1'
  },
  negative: {
    primary: '#E53935',    // Îπ®Í∞ï
    secondary: '#FF6F00',  // Ï£ºÌô© (ÎåÄÏ≤¥ÏÉâ)
    text: '#B71C1C'
  },
  neutral: {
    primary: '#616161',
    secondary: '#9E9E9E',
    text: '#424242'
  },
  
  // Ìå®ÌÑ¥ Ïò§Î≤ÑÎ†àÏù¥ (ÏÉâÏÉÅ Ïô∏ Íµ¨Î∂Ñ ÏöîÏÜå)
  patterns: {
    positive: 'url(#diagonal-lines-up)',
    negative: 'url(#diagonal-lines-down)',
    neutral: 'url(#dots)'
  }
};

// Í≥†ÎåÄÎπÑ ÏÉâÏÉÅ
export const HighContrastColors = {
  positive: {
    primary: '#000000',
    secondary: '#FFFFFF',
    text: '#000000'
  },
  negative: {
    primary: '#FFFFFF',
    secondary: '#000000',
    text: '#FFFFFF'
  },
  neutral: {
    primary: '#666666',
    secondary: '#CCCCCC',
    text: '#333333'
  }
};

// ÏïÑÏù¥ÏΩòÍ≥º ÌÖçÏä§Ìä∏ Î†àÏù¥Î∏î Î≥ëÌñâ
export const AccessibleWeatherIcons = {
  sunny: { 
    icon: '‚òÄÔ∏è', 
    label: 'ÎßëÏùå (ÏÉÅÏäπ)', 
    pattern: 'rising',
    description: 'ÏÉÅÏäπ Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏùÄ ÎÇ†Ïî®ÏûÖÎãàÎã§'
  },
  partlyCloudy: { 
    icon: 'üå§Ô∏è', 
    label: 'ÏïΩÍ∞Ñ Íµ¨Î¶Ñ (ÏïΩÏÉÅÏäπ)', 
    pattern: 'slight-rising',
    description: 'ÏïΩÍ∞ÑÏùò ÏÉÅÏäπ Í∞ÄÎä•ÏÑ±Ïù¥ ÏûàÏäµÎãàÎã§'
  },
  cloudy: { 
    icon: '‚õÖ', 
    label: 'Íµ¨Î¶Ñ (Î≥¥Ìï©)', 
    pattern: 'neutral',
    description: 'Î≥ÄÎèôÏÑ±Ïù¥ ÏûàÏùÑ Ïàò ÏûàÏäµÎãàÎã§'
  },
  overcast: { 
    icon: 'üå•Ô∏è', 
    label: 'ÌùêÎ¶º (ÏïΩÌïòÎùΩ)', 
    pattern: 'slight-falling',
    description: 'Ï°∞Ï†ï Í∞ÄÎä•ÏÑ±Ïù¥ ÏûàÏäµÎãàÎã§'
  },
  rainy: { 
    icon: 'üåßÔ∏è', 
    label: 'ÎπÑ (ÌïòÎùΩ)', 
    pattern: 'falling',
    description: 'ÌïòÎùΩ Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏùÄ ÎÇ†Ïî®ÏûÖÎãàÎã§'
  }
};

// ÌÇ§Î≥¥Îìú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌÇ§
export const KeyboardKeys = {
  ENTER: 'Enter',
  SPACE: ' ',
  ESCAPE: 'Escape',
  TAB: 'Tab',
  ARROW_UP: 'ArrowUp',
  ARROW_DOWN: 'ArrowDown',
  ARROW_LEFT: 'ArrowLeft',
  ARROW_RIGHT: 'ArrowRight',
  HOME: 'Home',
  END: 'End'
};

// Ïä§ÌÅ¨Î¶∞ Î¶¨Îçî Ï†ÑÏö© ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
export function generateScreenReaderText(stock: any): string {
  const direction = stock.probability >= 0.5 ? 'ÏÉÅÏäπ' : 'ÌïòÎùΩ';
  const confidence = `Ïã†Î¢∞ÎèÑ ${(stock.confidence * 100).toFixed(0)}ÌçºÏÑºÌä∏`;
  const fundamental = `ÌéÄÎçîÎ©òÌÑ∏ Ï†êÏàò ${(stock.fundamental_score * 100).toFixed(0)}Ï†ê`;
  
  return `${stock.name} Ï¢ÖÎ™©, ${direction} ÌôïÎ•† ${(stock.probability * 100).toFixed(0)}ÌçºÏÑºÌä∏, ${confidence}, ${fundamental}`;
}

// ARIA ÎùºÏù¥Î∏å Î¶¨Ï†Ñ ÏóÖÎç∞Ïù¥Ìä∏
export function announceToScreenReader(message: string, priority: 'polite' | 'assertive' = 'polite') {
  const announcement = document.createElement('div');
  announcement.setAttribute('role', 'status');
  announcement.setAttribute('aria-live', priority);
  announcement.setAttribute('aria-atomic', 'true');
  announcement.className = 'sr-only';
  announcement.textContent = message;
  
  document.body.appendChild(announcement);
  
  // Î©îÏãúÏßÄ Ï†ÑÎã¨ ÌõÑ Ï†úÍ±∞
  setTimeout(() => {
    document.body.removeChild(announcement);
  }, 1000);
}

// Ìè¨Ïª§Ïä§ Ìä∏Îû© (Î™®Îã¨ Îì±ÏóêÏÑú ÏÇ¨Ïö©)
export class FocusTrap {
  private element: HTMLElement;
  private focusableElements: HTMLElement[];
  private firstFocusable: HTMLElement | null;
  private lastFocusable: HTMLElement | null;
  
  constructor(element: HTMLElement) {
    this.element = element;
    this.focusableElements = this.getFocusableElements();
    this.firstFocusable = this.focusableElements[0] || null;
    this.lastFocusable = this.focusableElements[this.focusableElements.length - 1] || null;
  }
  
  private getFocusableElements(): HTMLElement[] {
    const selectors = [
      'a[href]',
      'button:not([disabled])',
      'textarea:not([disabled])',
      'input:not([disabled])',
      'select:not([disabled])',
      '[tabindex]:not([tabindex="-1"])'
    ];
    
    return Array.from(
      this.element.querySelectorAll<HTMLElement>(selectors.join(','))
    );
  }
  
  public activate() {
    if (this.firstFocusable) {
      this.firstFocusable.focus();
    }
    
    this.element.addEventListener('keydown', this.handleKeyDown);
  }
  
  public deactivate() {
    this.element.removeEventListener('keydown', this.handleKeyDown);
  }
  
  private handleKeyDown = (e: KeyboardEvent) => {
    if (e.key !== 'Tab') return;
    
    if (e.shiftKey) {
      // Shift + Tab
      if (document.activeElement === this.firstFocusable && this.lastFocusable) {
        e.preventDefault();
        this.lastFocusable.focus();
      }
    } else {
      // Tab
      if (document.activeElement === this.lastFocusable && this.firstFocusable) {
        e.preventDefault();
        this.firstFocusable.focus();
      }
    }
  };
}

// ÏÉâÏÉÅ ÎåÄÎπÑ Í≤ÄÏÇ¨
export function checkColorContrast(
  foreground: string, 
  background: string
): { ratio: number; passes: { aa: boolean; aaa: boolean } } {
  // Í∞ÑÎã®Ìïú Íµ¨ÌòÑ (Ïã§Ï†úÎ°úÎäî Îçî Î≥µÏû°Ìïú Í≥ÑÏÇ∞ ÌïÑÏöî)
  // WCAG 2.1 Í∏∞Ï§Ä: AAÎäî 4.5:1, AAAÎäî 7:1
  
  const ratio = 4.5; // ÎçîÎØ∏ Í∞í
  
  return {
    ratio,
    passes: {
      aa: ratio >= 4.5,
      aaa: ratio >= 7
    }
  };
}

// Ïï†ÎãàÎ©îÏù¥ÏÖò Í∞êÏÜå ÏÑ§Ï†ï ÌôïÏù∏
export function prefersReducedMotion(): boolean {
  if (typeof window === 'undefined') return false;
  
  const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
  return mediaQuery.matches;
}

// Îã§ÌÅ¨ Î™®Îìú ÏÑ†Ìò∏ ÌôïÏù∏
export function prefersDarkMode(): boolean {
  if (typeof window === 'undefined') return false;
  
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
  return mediaQuery.matches;
}

// ÌÑ∞Ïπò ÎîîÎ∞îÏù¥Ïä§ ÌôïÏù∏
export function isTouchDevice(): boolean {
  if (typeof window === 'undefined') return false;
  
  return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
}

// Ï†ëÍ∑ºÏÑ± ÏÑ§Ï†ï Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Í¥ÄÎ¶¨
export const AccessibilitySettings = {
  get: () => {
    if (typeof window === 'undefined') return {};
    
    const stored = localStorage.getItem('accessibility_settings');
    return stored ? JSON.parse(stored) : {};
  },
  
  set: (settings: any) => {
    if (typeof window === 'undefined') return;
    
    localStorage.setItem('accessibility_settings', JSON.stringify(settings));
  },
  
  update: (key: string, value: any) => {
    const current = AccessibilitySettings.get();
    current[key] = value;
    AccessibilitySettings.set(current);
  }
};

// Ï†ëÍ∑ºÏÑ± Îã®Ï∂ïÌÇ§ Î∞îÏù∏Îî©
export const AccessibilityShortcuts = {
  // Alt + 1: Î©îÏù∏ ÏΩòÌÖêÏ∏†Î°ú Ïù¥Îèô
  skipToMain: (e: KeyboardEvent) => {
    if (e.altKey && e.key === '1') {
      e.preventDefault();
      const main = document.querySelector('main');
      if (main) {
        (main as HTMLElement).focus();
        announceToScreenReader('Î©îÏù∏ ÏΩòÌÖêÏ∏†Î°ú Ïù¥ÎèôÌñàÏäµÎãàÎã§');
      }
    }
  },
  
  // Alt + 2: ÎÑ§ÎπÑÍ≤åÏù¥ÏÖòÏúºÎ°ú Ïù¥Îèô
  skipToNav: (e: KeyboardEvent) => {
    if (e.altKey && e.key === '2') {
      e.preventDefault();
      const nav = document.querySelector('nav');
      if (nav) {
        (nav as HTMLElement).focus();
        announceToScreenReader('ÎÑ§ÎπÑÍ≤åÏù¥ÏÖòÏúºÎ°ú Ïù¥ÎèôÌñàÏäµÎãàÎã§');
      }
    }
  },
  
  // Alt + S: Í≤ÄÏÉâÏúºÎ°ú Ïù¥Îèô
  skipToSearch: (e: KeyboardEvent) => {
    if (e.altKey && e.key === 's') {
      e.preventDefault();
      const search = document.querySelector('[role="search"]');
      if (search) {
        const input = search.querySelector('input');
        if (input) {
          (input as HTMLElement).focus();
          announceToScreenReader('Í≤ÄÏÉâÏúºÎ°ú Ïù¥ÎèôÌñàÏäµÎãàÎã§');
        }
      }
    }
  },
  
  // Escape: Î™®Îã¨/ÌåùÏóÖ Îã´Í∏∞
  closeModal: (e: KeyboardEvent, callback: () => void) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      callback();
      announceToScreenReader('Ï∞ΩÏù¥ Îã´ÌòîÏäµÎãàÎã§');
    }
  }
};

// Ï†ëÍ∑ºÏÑ± Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
export const AccessibilityChecklist = {
  // Ïù¥ÎØ∏ÏßÄ ÎåÄÏ≤¥ ÌÖçÏä§Ìä∏ ÌôïÏù∏
  checkAltText: () => {
    const images = document.querySelectorAll('img');
    const missing: HTMLElement[] = [];
    
    images.forEach(img => {
      if (!img.getAttribute('alt')) {
        missing.push(img as HTMLElement);
      }
    });
    
    return {
      total: images.length,
      missing: missing.length,
      elements: missing
    };
  },
  
  // Ìó§Îî© Íµ¨Ï°∞ ÌôïÏù∏
  checkHeadingStructure: () => {
    const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
    const structure: number[] = [];
    let hasMultipleH1 = false;
    let hasSkippedLevel = false;
    
    headings.forEach((heading, index) => {
      const level = parseInt(heading.tagName.substring(1));
      structure.push(level);
      
      if (level === 1 && structure.filter(l => l === 1).length > 1) {
        hasMultipleH1 = true;
      }
      
      if (index > 0 && level > structure[index - 1] + 1) {
        hasSkippedLevel = true;
      }
    });
    
    return {
      structure,
      hasMultipleH1,
      hasSkippedLevel,
      isValid: !hasMultipleH1 && !hasSkippedLevel
    };
  },
  
  // Ìèº Î†àÏù¥Î∏î ÌôïÏù∏
  checkFormLabels: () => {
    const inputs = document.querySelectorAll('input, select, textarea');
    const unlabeled: HTMLElement[] = [];
    
    inputs.forEach(input => {
      const id = input.getAttribute('id');
      const hasLabel = id && document.querySelector(`label[for="${id}"]`);
      const hasAriaLabel = input.getAttribute('aria-label');
      const hasAriaLabelledby = input.getAttribute('aria-labelledby');
      
      if (!hasLabel && !hasAriaLabel && !hasAriaLabelledby) {
        unlabeled.push(input as HTMLElement);
      }
    });
    
    return {
      total: inputs.length,
      unlabeled: unlabeled.length,
      elements: unlabeled
    };
  }
};

// Ìè¨Ïª§Ïä§ Í∞ÄÏãúÏÑ± Ìñ•ÏÉÅ
export function enhanceFocusVisibility() {
  const style = document.createElement('style');
  style.textContent = `
    *:focus {
      outline: 3px solid #4A90E2 !important;
      outline-offset: 2px !important;
    }
    
    *:focus:not(:focus-visible) {
      outline: none !important;
    }
    
    *:focus-visible {
      outline: 3px solid #4A90E2 !important;
      outline-offset: 2px !important;
    }
  `;
  document.head.appendChild(style);
}

// ÌÖçÏä§Ìä∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï
export function adjustTextSize(factor: number) {
  const root = document.documentElement;
  const currentSize = parseFloat(getComputedStyle(root).fontSize);
  const newSize = currentSize * factor;
  
  // ÏµúÏÜå 12px, ÏµúÎåÄ 24px
  if (newSize >= 12 && newSize <= 24) {
    root.style.fontSize = `${newSize}px`;
    announceToScreenReader(`ÌÖçÏä§Ìä∏ ÌÅ¨Í∏∞Í∞Ä ${Math.round(factor * 100)}%Î°ú Ï°∞Ï†ïÎêòÏóàÏäµÎãàÎã§`);
  }
}

// ÎßÅÌÅ¨ ÌÉÄÍ≤ü ÌôïÏù∏ (ÏÉà Ï∞Ω Ïó¥Î¶º Í≤ΩÍ≥†)
export function checkExternalLinks() {
  const links = document.querySelectorAll('a[target="_blank"]');
  
  links.forEach(link => {
    const text = link.textContent || '';
    if (!text.includes('ÏÉà Ï∞Ω')) {
      // aria-label Ï∂îÍ∞Ä
      const currentLabel = link.getAttribute('aria-label') || text;
      link.setAttribute('aria-label', `${currentLabel} (ÏÉà Ï∞ΩÏóêÏÑú Ïó¥Î¶º)`);
      
      // ÏãúÍ∞ÅÏ†Å ÌëúÏãú Ï∂îÍ∞Ä
      if (!link.querySelector('.external-indicator')) {
        const indicator = document.createElement('span');
        indicator.className = 'external-indicator';
        indicator.textContent = ' ‚Üó';
        indicator.setAttribute('aria-hidden', 'true');
        link.appendChild(indicator);
      }
    }
  });
}
